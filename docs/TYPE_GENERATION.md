# Type Generation Strategy

## Problem

The `@atcute/lex-cli` tool generates TypeScript types from lexicon schemas, but
includes a `declare module` statement for global type augmentation:

```typescript
declare module "@atcute/lexicons/ambient" {
  interface Records {
    "net.altq.aqfile": mainSchema;
  }
}
```

JSR (JavaScript Registry) currently
[does not support global type augmentations](https://github.com/denoland/deno/issues/23427)
as a temporary measure while they work on a solution.

## Solution

We maintain **two sets of types**:

### 1. Generated Types (Development Only)

- Location: `src/lexicons/` (excluded from JSR publish)
- Generated by: `deno task lex` using `@atcute/lex-cli`
- Purpose: Reference for keeping manual types up-to-date
- Used by: Nothing in the published package

### 2. Manual Types (Published)

- Location: `src/types.ts`
- Maintained: Manually, based on the lexicon schema
- Purpose: Provide type safety without global augmentation
- Used by: `src/main.ts`, `src/utils.ts`, and published to JSR

## Workflow

1. **When lexicon schema changes:**
   ```bash
   deno task lex  # Generate types to src/lexicons/
   ```

2. **Update manual types:**
   - Review changes in `src/lexicons/types/net/altq/aqfile.ts`
   - Update `src/types.ts` to match (excluding the `declare module` part)

3. **Verify:**
   ```bash
   deno check src/main.ts
   deno task test
   deno publish --dry-run --allow-dirty
   ```

## Trade-offs

**Pros:**

- ✅ Can publish to JSR without restrictions
- ✅ Full type safety in development
- ✅ No build step required
- ✅ Clear separation of concerns

**Cons:**

- ❌ Manual maintenance when lexicon changes
- ❌ Duplication of type definitions
- ❌ Need to keep types in sync

## Future

When JSR adds support for global type augmentations
([tracking issue](https://github.com/denoland/deno/issues/23427)):

- Remove `src/types.ts`
- Update imports to use `src/lexicons/index.ts`
- Remove lexicons from `publish.exclude`
- Benefit from automatic type generation
